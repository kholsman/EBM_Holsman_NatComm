---
title: "EBM Nature Communications main script"
author: "Kirstin Holsman"
date: "2/17/2020"
output:
  pdf_document:
    fig_caption: yes
    highlight: tango
    keep_tex: yes
    latex_engine: xelatex
  html_document:
    df_print: kable
    fig_caption: yes
    theme: flatly
  header-includes:
  - \usepackage{inputenc}
  - \usepackage{unicode-math}
  - \pagenumbering{gobble}ls()

  word_document:
    fig_caption: yes
    fig_width: 4
    keep_md: yes
---



# Data and code are under review and subject to change. Do not use without permission from lead author: kirstin.holsman@noaa.gov

#### Kirstin Holsman
#### kirstin.holsman@noaa.gov
#### Alaska Fisheries Science Center, National Marine Fisheries Service, NOAA, 7600 Sand Point Way N.E., Bld. 4, Seattle, Washington 98115

---

Code used to generate intermediate and final data for Holsman et al. in review Nature Communications paper

## Input data:

### Option 1: Re-generate final data for plots
If running plotting code below (recommended) you will need to download the final data "EBM_ceattlenew.Rdata" from figshare and place it in the main directory: "EBM_Holsman_NatComm/EBM_ceattlenew.Rdata".

* access EBM_ceattlenew.Rdata here: https://figshare.com/s/6dea7722df39e07d79f0 and place it in the directory: EBM_Holsman_NatComm/EBM_ceattlenew.Rdata. 
(Data DOI:10.6084/m9.figshare.11864505)

### Option 2: Re-running the intermediate data (not recommended)
If re-running the intermediate data analysis (not recommended) the following files will need to be downloaded unzipped and placed in the asssesment_files folder:

* access aclim_00_JunV2_2019_2.zip here: https://figshare.com/s/3a1aaa86837b79d6aa07 and place it in the EBM_Holsman_NatComm/data/runs/aclim_00_JunV2_2019_2.zip and unzip.
(Data DOI:10.6084/m9.figshare.11864586)

* access aclim_00_JunV2_2019_0.zip here: https://figshare.com/s/d9c35dbe0880f4169041 and place it in the EBM_Holsman_NatComm/data/runs/aclim_00_JunV2_2019_0.zip and unzip
(Data DOI:10.6084/m9.figshare.11864577)


## Intermediate data:
Intermediate data can be found in the main EBM_Holsman_NatComm in the form of .Rdata files but can be recreated (although this is not recommended; see below) from the ADMB model using the EBM_Holsman_NatComm/assessment_scripts/README_EBM_Holsman_Analysis.pdf.

## Figures and tables:
Final figures and tables (including illustrator files that were used to add fish icons) can be found in the **Figures** folder.


This is the main script for running analysis and plotting results and requires R version 3.5.3 (available at https://cran.r-project.org/bin/macosx/el-capitan/base/). To update the analysis using .Rdata outputs run the R() code below as is currently configured. If you want to update the intermediate data, set "readdat" to TRUE in line 80 below. The CEATTLE stock assessment is also included but requires AD Model builder (http://www.admb-project.org). To run the assessment scripts (not recommended or tested outside of macOSX) see "README_EBM_Holsman_Analysis.pdf".

### EMB_paper.R script:

```{r EBM_paper, eval=FALSE, echo=TRUE}

## ------------------------------------------------
## plotting code for EBM paper 
## Kirstin Holsman 
## Feb 2020
## Kirstin.holsman@noaa.gov
## ------------------------------------------------

# 1. Set up
# 2. load data
# 3.  make figures


    rm(list=ls())
    graphics.off()
    interactive()
    
  #-------------------------------------
  #   1. SET THINGS UP
  #------------------------------------- 
     # set your local path:
    main  <-  path.expand("~/GitHub_new/EBM_Holsman_NatComm/")
    setwd(main)
    
    # make the drake plan:
    source("R/make.R")
    
    # see the workflow
    vis_drake_graph(plan)
    
   
   

    riskTypes       <-  c("10% decline","50% decline","80% decline")
    RISK            <-  list("no cap" = risk12,"2 MT cap" = risk13)
    timeF           <-  levels(risk12$timeframe)
    
    flList          <-  dir("data/runs",paste0(fldr,"_0"))
    txt             <-  c("no cap"="_219_CENaivecf_2_5_12","2MT cap"="_2MT_219_CENaivecf1_2_5_13")
    fldin           <-  (paste0("data/runs/",fldr,"_2/projections/",fldr,txt,"/",fldr,txt,".ctl")) # KEY RUN
    target_B_2      <-  rbind(
                          getBtarget(fldrIN=fldin[1],nm="B0_set"),
                          getBtarget(fldrIN=fldin[2],nm="B0_set"))
    rownames(target_B_2)  <-  names(txt)
    txt              <-  c("no cap"="_019_CENaivecf_0_5_12","2MT cap"="_2MT_019_CENaivecf1_0_5_13")
    fldin            <-  (paste0("data/runs/",fldr,"_0/projections/",fldr,txt,"/",fldr,txt,".ctl")) # KEY RUN
    target_B_0       <-  rbind(
                          getBtarget(fldrIN=fldin[1],nm="B0_set"),
                          getBtarget(fldrIN=fldin[2],nm="B0_set"))
    rownames(target_B_0)<-names(txt)

    
# set up some plotting labels
    A1B_n_sim           <-  grep("A1B",simnames)
    bio_n_sim           <-  grep("bio",simnames)
    rcp45_n_sim         <-  grep("rcp45",simnames)
    rcp85_n_sim         <-  grep("rcp85",simnames)
    rcp85NoBio_n_sim    <-  setdiff(rcp85_n_sim,bio_n_sim)
    meanhistT           <-  mean(TempC_219_CENaivecf_2_5_12_mc[s,,,1][1,][hind_yrs])
      
 source("R/make_plots.R")


```
